---
title: "Project-2"
author: "Jacob Press"
date: '2023-10-09'
output: github_document
---
# Project Purpose  

I don't watch hockey but for a while I have thought about getting into hockey. So I decided to use the data from the NHL API to see if I can get an idea of what teams are good.  

# Intall Packages  
Below I am installing all the necessary packages.  

```{r packages, message=FALSE, warning=FALSE}
library(jsonlite)
library(tidyverse)
```

# Functions to Quiry API  

Here I made a list of the `teamNames` corresponding to their `teamID` to be used if needed when calling the functions I made.

```{r teamList, warning=FALSE, message=FALSE}
outputAPI1 <- fromJSON("https://records.nhl.com/site/api/franchise-season-results")
  list <- outputAPI1$data  
  teamID<- list %>% select(teamId, teamName) %>% arrange(teamId) %>% distinct(teamId, teamName)
  teamID
```

Below is are some functions I made to query the NHL API. The above data frame serves as a key for the team names and corresponding `teamID`. There are 2 additional filters the user can add for whether the games are regular season, playoff games and if the team is an active hockey team or not. 
  
* game = 2 for regular season game  
* game = 3 for playoff game  
* active = TRUE for active teams  
* active = FALSE for non active teams  

The functions I wrote are:  
  
1. `allTeamTotals` with the filters `active` and `game` will return all the stats for each active or inactive team for their regular season or playoff games. 
1. `teamWLTotals` with the filter `team` and `games` will return the win/loss data for a team which is input by the user for their regular or playoff season. 1. 

```{r functions, warning=FALSE, message=FALSE}
# team totals for active NHL teams for either regular or playoff games.
allTeamTotals <- function(active = TRUE, game = 2){
  baseURL <- "https://records.nhl.com/site/api/"
  filterURL <- "franchise-team-totals?cayenneExp=activeTeam="
  filterURL2 <- "%20and%20gameTypeId="
  fullURL <- paste0(baseURL, filterURL, active, filterURL2, game)
  output <- fromJSON(fullURL)
  return(output$data)
}
# win loss totals for a given team for either regular or playoff games
teamWLTotals <- function(team = 12, game = 2){
  baseURL <- "https://records.nhl.com/site/api/"
  filterURL1 <- "franchise-team-totals?cayenneExp=teamId="
  fitlerURL2 <- "%20and%20gameTypeId="
  fullURL <- paste0(baseURL, filterURL1, team, fitlerURL2, game)
  outputAPI <- fromJSON(fullURL)
    output <- outputAPI$data %>% select(teamName, contains("wins"), homeLosses, roadLosses, losses, gamesPlayed, gameWinPctg)
    return(output)
}
# win loss totals by season
wlTotalBySeason <- function(){
  outputAPI <- fromJSON("https://records.nhl.com/site/api/franchise-season-results")
    output <- outputAPI$data %>% arrange(teamId) 
    return(output)
}  
# win loss totals by season for a given team for regular or playoff games.
teamWLTotalBySeason <- function(team = 12, game = 2){
  baseURL <- "https://records.nhl.com/site/api/"
  filterURL1 <- "franchise-season-results?cayenneExp=teamId="
  fitlerURL2 <- "%20and%20gameTypeId="
  fullURL <- paste0(baseURL, filterURL1, team, fitlerURL2, game)
  outputAPI <- fromJSON(fullURL)
    output <- outputAPI$data %>% arrange(seasonId) %>% filter(seasonId != 20232024) %>%
      mutate(year = as.numeric(substr(seasonId, 5,8))) %>%
      select(teamName, seasonId, year, contains("wins"), homeLosses, roadLosses, losses, gamesPlayed)
    return(output)
}

```

I am interested in finding the best active NHL team.

```{r EDA, warning=FALSE, message=FALSE}
# contingency table for the number of cups each active NHL team has.
allteamTotals <- allTeamTotals(active = TRUE, game = 2) %>% mutate(avgWinPct = mean(gameWinPctg))
  table(allteamTotals$teamName, allteamTotals$cups)
  
# teams win the 5 highest regular season win percentages
topWinPercent <- allTeamTotals(active = TRUE, game = 2) %>%
  arrange(desc(gameWinPctg)) %>% distinct(teamName, .keep_all = TRUE) %>% select(teamName, teamId, gameWinPctg, cups)
  head(topWinPercent,5)
  
VegasGoldenKnights <- teamWLTotalBySeason(54,2) %>% 
  mutate(meanWins = mean(wins, na.rm = TRUE), winPctg = wins/gamesPlayed, overallWinPctg = teamWLTotals(54,2)$gameWinPctg)

coloradoAvalanche <- teamWLTotalBySeason(21,2) %>% 
  mutate(meanWins = mean(wins, na.rm = TRUE), winPctg = wins/gamesPlayed, overallWinPctg = teamWLTotals(21,2)$gameWinPctg)

dallasStars <- teamWLTotalBySeason(25,2) %>% 
  mutate(meanWins = mean(wins, na.rm = TRUE), winPctg = wins/gamesPlayed, overallWinPctg = teamWLTotals(25,2)$gameWinPctg)

winnipegJets <- teamWLTotalBySeason(52,2) %>% 
  mutate(meanWins = mean(wins, na.rm = TRUE), winPctg = wins/gamesPlayed, overallWinPctg = teamWLTotals(52,2)$gameWinPctg)

montrealCanadiens <- teamWLTotalBySeason(8,2) %>% 
  mutate(meanWins = mean(wins, na.rm = TRUE), winPctg = wins/gamesPlayed, overallWinPctg = teamWLTotals(8,2)$gameWinPctg)

carolinaHurricanes <- teamWLTotalBySeason(12,2) %>% 
  mutate(meanWins = mean(wins, na.rm = TRUE), winPctg = wins/gamesPlayed, overallWinPctg = teamWLTotals(12,2)$gameWinPctg)

```

```{r graphs, warning=FALSE, message=FALSE}
g <- ggplot(data = allteamTotals, aes(x= gameWinPctg))
g + geom_boxplot(outlier.colour = "red") + labs(x = "Win Percentage", title = "Box Plot of Regular Season Win Percentages")

g <- ggplot(data = VegasGoldenKnights, aes(x = year, y = winPctg))
g + geom_line(color = "darkseagreen", size = 1.2) + geom_point(color = "darkslategrey", size = 3) + 
  labs(x = "Year", y = "win Percentage", title = "Vegas Golden Knights Win Percentage by Year") + 
    geom_hline(aes(yintercept = overallWinPctg, linetype = "Vegas Golden Knights"), color = "purple") + 
      geom_hline(aes(yintercept = allteamTotals$avgWinPct[1], linetype = "All Teams"), color = "red") +
        scale_linetype_manual(name = "Average Win Percentage", values = c(1,2), guide = guide_legend(override.aes = list(color = c("red", "purple"))))

g <- ggplot(data = coloradoAvalanche, aes(x = year, y = winPctg))
g + geom_line(color = "darkseagreen", size = 1.2) + geom_point(color = "darkslategrey", size = 3) + 
  labs(x = "Year", y = "win Percentage", title = "Colorado Avalanche Win Percentage by Year") + 
    geom_hline(aes(yintercept = overallWinPctg, linetype = "Colorado Avalanche"), color = "purple") + 
      geom_hline(aes(yintercept = allteamTotals$avgWinPct[1], linetype = "All Teams"), color = "red") +
        scale_linetype_manual(name = "Average Win Percentage", values = c(1,2), guide = guide_legend(override.aes = list(color = c("red", "purple"))))

g <- ggplot(data = dallasStars, aes(x = year, y = winPctg))
g + geom_line(color = "darkseagreen", size = 1.2) + geom_point(color = "darkslategrey", size = 3) + 
  labs(x = "Year", y = "win Percentage", title = "Dallas Stars Win Percentage by Year") + 
    geom_hline(aes(yintercept = overallWinPctg, linetype = "Dallas Stars"), color = "purple") + 
      geom_hline(aes(yintercept = allteamTotals$avgWinPct[1], linetype = "All Teams"), color = "red") +
        scale_linetype_manual(name = "Average Win Percentage", values = c(1,2), guide = guide_legend(override.aes = list(color = c("red", "purple"))))

g <- ggplot(data = winnipegJets, aes(x = year, y = winPctg))
g + geom_line(color = "darkseagreen", size = 1.2) + geom_point(color = "darkslategrey", size = 3) + 
  labs(x = "Year", y = "win Percentage", title = "Winnipeg Jets Win Percentage by Year") + 
    geom_hline(aes(yintercept = overallWinPctg, linetype = "Winnipeg Jets"), color = "purple") + 
      geom_hline(aes(yintercept = allteamTotals$avgWinPct[1], linetype = "All Teams"), color = "red") +
        scale_linetype_manual(name = "Average Win Percentage", values = c(1,2), guide = guide_legend(override.aes = list(color = c("red", "purple"))))

g <- ggplot(data = montrealCanadiens, aes(x = year, y = winPctg))
g + geom_line(color = "darkseagreen", size = 1.2) + geom_point(color = "darkslategrey", size = 3) + 
  labs(x = "Year", y = "win Percentage", title = "Montreal Canadiens Win Percentage by Year") + 
  geom_hline(aes(yintercept = overallWinPctg, linetype = "Montreal Canadiens"), color = "purple") + 
  geom_hline(aes(yintercept = allteamTotals$avgWinPct[1], linetype = "All Teams"), color = "red") +
  scale_linetype_manual(name = "Average Win Percentage", values = c(1,2), guide = guide_legend(override.aes = list(color = c("red", "purple"))))

g <- ggplot(data = carolinaHurricanes, aes(x = year, y = winPctg))
g + geom_line(color = "darkseagreen", size = 1.2) + geom_point(color = "darkslategrey", size = 3) + 
  labs(x = "Year", y = "win Percentage", title = "Carolina Hurricanes Win Percentage by Year") + 
  geom_hline(aes(yintercept = overallWinPctg, linetype = "Carolina Hurricanes"), color = "purple") + 
  geom_hline(aes(yintercept = allteamTotals$avgWinPct[1], linetype = "All Teams"), color = "red") +
  scale_linetype_manual(name = "Average Win Percentage", values = c(1,2), guide = guide_legend(override.aes = list(color = c("red", "purple"))))

```

```{r, message=FALSE, warning=FALSE}
data <- wlTotalBySeason()
g <- ggplot(data = data, aes(x= teamName, y = seasonId, fill = wins))
  g + geom_tile()
```


rmarkdown::render(input = "Project-2.Rmd", output_format = "github_document", output_file = "README.md")